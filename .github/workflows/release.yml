# Tori Wallet - Release Workflow
# ì•± ìŠ¤í† ì–´ / í”Œë ˆì´ ìŠ¤í† ì–´ ë°°í¬ ìë™í™”
#
# ğŸ” í•„ìš”í•œ GitHub Secrets:
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê³µí†µ:
#   - WALLETCONNECT_PROJECT_ID: WalletConnect í”„ë¡œì íŠ¸ ID
#
# Android (Google Play Console):
#   - ANDROID_KEYSTORE_BASE64: ë¦´ë¦¬ì¦ˆ í‚¤ìŠ¤í† ì–´ íŒŒì¼ (base64 ì¸ì½”ë”©)
#   - ANDROID_KEYSTORE_PASSWORD: í‚¤ìŠ¤í† ì–´ ë¹„ë°€ë²ˆí˜¸
#   - ANDROID_KEY_ALIAS: í‚¤ ë³„ì¹­
#   - ANDROID_KEY_PASSWORD: í‚¤ ë¹„ë°€ë²ˆí˜¸
#   - GOOGLE_PLAY_SERVICE_ACCOUNT_JSON: Google Play API ì„œë¹„ìŠ¤ ê³„ì • JSON
#
# iOS (App Store Connect):
#   - APPLE_TEAM_ID: Apple Developer Team ID
#   - APP_STORE_CONNECT_API_KEY_ID: App Store Connect API Key ID
#   - APP_STORE_CONNECT_API_ISSUER_ID: App Store Connect Issuer ID
#   - APP_STORE_CONNECT_API_KEY_CONTENT: App Store Connect API Key (.p8 ë‚´ìš©)
#   - IOS_DISTRIBUTION_CERTIFICATE_BASE64: ë°°í¬ ì¸ì¦ì„œ (base64)
#   - IOS_DISTRIBUTION_CERTIFICATE_PASSWORD: ì¸ì¦ì„œ ë¹„ë°€ë²ˆí˜¸
#   - IOS_PROVISIONING_PROFILE_BASE64: í”„ë¡œë¹„ì €ë‹ í”„ë¡œíŒŒì¼ (base64)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

name: Release

on:
  push:
    tags:
      - 'v*' # v1.0.0, v1.2.3 ë“± íƒœê·¸ í‘¸ì‹œ ì‹œ ì‹¤í–‰
  workflow_dispatch:
    inputs:
      platform:
        description: 'Platform to release'
        required: true
        default: 'both'
        type: choice
        options:
          - android
          - ios
          - both
      track:
        description: 'Release track'
        required: true
        default: 'internal'
        type: choice
        options:
          - internal
          - alpha
          - beta
          - production

env:
  NODE_VERSION: '20'
  RUBY_VERSION: '3.2'
  JAVA_VERSION: '17'

jobs:
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Android Release - Google Play Console
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release-android:
    name: Release Android
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'push' || 
      github.event.inputs.platform == 'android' || 
      github.event.inputs.platform == 'both'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: ${{ env.JAVA_VERSION }}

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Create .env file
        run: |
          echo "WALLETCONNECT_PROJECT_ID=${{ secrets.WALLETCONNECT_PROJECT_ID }}" > .env

      - name: Decode Keystore
        run: |
          echo "${{ secrets.ANDROID_KEYSTORE_BASE64 }}" | base64 --decode > android/app/release.keystore

      - name: Create keystore.properties
        run: |
          cat > android/keystore.properties << EOF
          storeFile=release.keystore
          storePassword=${{ secrets.ANDROID_KEYSTORE_PASSWORD }}
          keyAlias=${{ secrets.ANDROID_KEY_ALIAS }}
          keyPassword=${{ secrets.ANDROID_KEY_PASSWORD }}
          EOF

      - name: Build Release AAB
        run: |
          cd android
          ./gradlew bundleRelease

      - name: Upload AAB to Google Play
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJsonPlainText: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT_JSON }}
          packageName: com.toriwallet
          releaseFiles: android/app/build/outputs/bundle/release/app-release.aab
          track: ${{ github.event.inputs.track || 'internal' }}
          status: completed

      - name: Upload AAB artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-aab
          path: android/app/build/outputs/bundle/release/app-release.aab

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # iOS Release - App Store Connect
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  release-ios:
    name: Release iOS
    runs-on: macos-latest
    if: |
      github.event_name == 'push' || 
      github.event.inputs.platform == 'ios' || 
      github.event.inputs.platform == 'both'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'yarn'

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ env.RUBY_VERSION }}
          bundler-cache: true

      - name: Install dependencies
        run: yarn install --frozen-lockfile

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Create .env file
        run: |
          echo "WALLETCONNECT_PROJECT_ID=${{ secrets.WALLETCONNECT_PROJECT_ID }}" > .env

      - name: Install Apple Certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_BASE64 }}
          p12-password: ${{ secrets.IOS_DISTRIBUTION_CERTIFICATE_PASSWORD }}

      - name: Install Provisioning Profile
        run: |
          mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
          echo "${{ secrets.IOS_PROVISIONING_PROFILE_BASE64 }}" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/distribution.mobileprovision

      - name: Build iOS Archive
        run: |
          xcodebuild -workspace ios/ToriWallet.xcworkspace \
            -scheme ToriWallet \
            -configuration Release \
            -archivePath $PWD/build/ToriWallet.xcarchive \
            archive \
            CODE_SIGN_STYLE=Manual \
            DEVELOPMENT_TEAM=${{ secrets.APPLE_TEAM_ID }}

      - name: Export IPA
        run: |
          cat > ExportOptions.plist << EOF
          <?xml version="1.0" encoding="UTF-8"?>
          <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
          <plist version="1.0">
          <dict>
            <key>method</key>
            <string>app-store</string>
            <key>teamID</key>
            <string>${{ secrets.APPLE_TEAM_ID }}</string>
            <key>uploadSymbols</key>
            <true/>
            <key>uploadBitcode</key>
            <false/>
          </dict>
          </plist>
          EOF

          xcodebuild -exportArchive \
            -archivePath $PWD/build/ToriWallet.xcarchive \
            -exportOptionsPlist ExportOptions.plist \
            -exportPath $PWD/build

      - name: Upload to App Store Connect
        uses: apple-actions/upload-testflight-build@v1
        with:
          app-path: build/ToriWallet.ipa
          issuer-id: ${{ secrets.APP_STORE_CONNECT_API_ISSUER_ID }}
          api-key-id: ${{ secrets.APP_STORE_CONNECT_API_KEY_ID }}
          api-private-key: ${{ secrets.APP_STORE_CONNECT_API_KEY_CONTENT }}

      - name: Upload IPA artifact
        uses: actions/upload-artifact@v4
        with:
          name: ios-release-ipa
          path: build/ToriWallet.ipa

  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  # Create GitHub Release
  # â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [release-android, release-ios]
    if: startsWith(github.ref, 'refs/tags/v')

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: android-release-aab
          path: artifacts/android

      - name: Download iOS artifact
        uses: actions/download-artifact@v4
        with:
          name: ios-release-ipa
          path: artifacts/ios

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            artifacts/android/app-release.aab
            artifacts/ios/ToriWallet.ipa
          generate_release_notes: true
          draft: false
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
